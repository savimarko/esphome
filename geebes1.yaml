# Example ESPHome code to emulate stock firmware functionality while maintaining 100% 
# local control through Home Assistant.

substitutions:
  device_name: 'geebes1'     # used internally.. e.g. teckin_sp20
  friendly_name: 'Kahvinkeitin'   # displayed in HA.. e.g. Teckin SP20

esphome:
  name: ${device_name}
  platform: ESP8266
  board: esp01_1m

wifi:
  ssid: !secret iot_ssid
  password: !secret iot_ssid_passwd

# Enable Logs from the device
logger:

# Enable Home Assistant API
api:

# Enable Over-The-Air updates
ota:

sensor:
  # Power measuring sensor
  - platform: hlw8012
    sel_pin:
      number: GPIO12
      inverted: True
    cf_pin: GPIO5
    cf1_pin: GPIO14
    current:
      name: ${friendly_name} Current
    power:
      name: ${friendly_name} Power
      id: power
      filters:
        # Some calibration
        - multiply: 0.4545
    voltage:
      name: ${friendly_name} Voltage
    current_resistor: 0.001  # default 0.001
    voltage_divider: 910     # default 2351
    change_mode_every: 8     # default 8
    update_interval: 60s      # default 60s

  # Sum power readings over the day
  - platform: total_daily_energy
    name: ${friendly_name} Total Daily Energy
    power_id: power
    filters:
      - multiply: 0.001   # convert Wh to kWh
    unit_of_measurement: kWh

# Enable getting local time for total daily energy calculation
time:
  - platform: homeassistant
    id: homeassistant_time

status_led:
  pin:
    number: GPIO0   # Red LED
    inverted: True

binary_sensor:
  - platform: gpio
    pin: GPIO13
    id: button
    name: ${friendly_name} Button
    on_press:
      - switch.toggle: relay
    internal: True
#######################
# tilakoneen tilat    #
#######################
  - platform: template
    name: "ON"
    id: coffee_machine_on
    filters:
        - delayed_off: 1s
    lambda: |-
      if (isnan(id(power).state)) 
      {
        return {};
      }
      else if (id(power).state > 5) 
      {
      return true;
      }
      else 
      {
        return false;
      }
    on_press:
      then: # at cycle start i reset all binary sensors
        - lambda: |-  
            {
              id(coffee_machine_brewing).publish_state(false);
              id(coffee_machine_keeping_warm).publish_state(false);
              id(coffee_machine_off).publish_state(false);
            }
        #- light.turn_on: led
    on_release:
      then: # at the end of cycle turn on end cycle
        - switch.turn_off: relay
        - lambda: |-  
            {
              id(coffee_machine_off).publish_state(true);
            }

  - platform: template
    name: "BREWING"
    id: coffee_machine_brewing
    lambda: |-
      if (isnan(id(power).state)) 
      {
        return {};
      } 
      else if (id(power).state > 500) 
      {
        return true;
      }
      else 
      {
        return false;
      }
  - platform: template
    name: "KEEPING WARM"
    id: coffee_machine_keeping_warm
    lambda: |-  
      if (isnan(id(power).state)) 
      {
        return {};
      } 
      else if ( (id(power).state > 5)&&(id(power).state < 500) )
      {
        return true;
      }
      else
      {
        return false;
      }    
  - platform: template
    name: "OFF"
    id: coffee_machine_off


switch:
  - platform: gpio
    id: blue_led
    pin:
      number: GPIO2
      inverted: True
    
  - platform: gpio
    pin: GPIO15
    id: relay
    name: ${friendly_name}
    # Tie Blue LED to relay
    on_turn_on:
    - switch.turn_on: blue_led
    on_turn_off:
    - switch.turn_off: blue_led
